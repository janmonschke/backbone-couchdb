<!DOCTYPE html>  <html> <head>   <title>app.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is a simple app that demonstrates how to use the Backbone.js couch-connector.
It is sort of a real time chat with private messages support.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Fill this with your database information.
<code>ddoc_name</code> is the name of your couchapp project.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">couch_connector</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">db_name</span> <span class="o">=</span> <span class="s2">&quot;backbone_connect&quot;</span><span class="p">;</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">couch_connector</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ddoc_name</span> <span class="o">=</span> <span class="s2">&quot;backbone_example&quot;</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If set to true, the connector will listen to the changes feed
and will provide your models with real time remote updates.
Backbone.couchConnector.enableChanges = true;</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Enables Mustache.js-like templating.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">interpolate</span> <span class="o">:</span> <span class="sr">/\{\{(.+?)\}\}/g</span>
  <span class="p">};</span>
  
  <span class="kd">var</span> <span class="nx">UserModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">defaults</span> <span class="o">:</span> <span class="p">{</span>
      <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Anonymus&quot;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="nb">window</span><span class="p">.</span><span class="nx">CurrentUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserModel</span><span class="p">();</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The model for a message is kinda simple.
We only need a name, a text and a date.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">MessageModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s2">&quot;date&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Now let's define a new Collection of Messages</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">MessagesList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">db</span> <span class="o">:</span> <span class="p">{</span>
      <span class="nx">view</span> <span class="o">:</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span>
      <span class="nx">changes</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">filter</span> <span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">couch_connector</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ddoc_name</span> <span class="o">+</span> <span class="s2">&quot;/messages&quot;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The couchdb-connector is capable of mapping the url scheme
proposed by the authors of Backbone to documents in your database,
so that you don't have to change existing apps when you switch the sync-strategy</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">url</span> <span class="o">:</span> <span class="s2">&quot;/messages&quot;</span><span class="p">,</span>
    <span class="nx">model</span> <span class="o">:</span> <span class="nx">MessageModel</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The messages should be ordered by date</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">comparator</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comment</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  
  <span class="kd">var</span> <span class="nx">Messages</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessagesList</span><span class="p">();</span>
  
  <span class="kd">var</span> <span class="nx">PrivateMessage</span> <span class="o">=</span> <span class="nx">MessageModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Private messages get an own collection because they need a filter</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">PrivateMessageList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">db</span> <span class="o">:</span> <span class="p">{</span>
      <span class="nx">view</span> <span class="o">:</span> <span class="s2">&quot;none__&quot;</span><span class="p">,</span>
      <span class="nx">changes</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The filter avoids that private messages appear in the public stream.
If you don't know what filters are in CouchDB, then read it up here:
<a href="http://guide.couchdb.org/draft/notifications.html#filters">http://guide.couchdb.org/draft/notifications.html#filters</a>
Look up how the filter works in <code>chat_example/filters/private_messages.js</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filter</span> <span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">couch_connector</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">ddoc_name</span> <span class="o">+</span> <span class="s2">&quot;/private_messages&quot;</span>
    <span class="p">},</span>
    
    <span class="nx">url</span> <span class="o">:</span> <span class="s2">&quot;/private_messages&quot;</span><span class="p">,</span>
    
    <span class="nx">model</span> <span class="o">:</span> <span class="nx">PrivateMessage</span>
  <span class="p">});</span>
  
  <span class="kd">var</span> <span class="nx">PrivateMessages</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PrivateMessageList</span><span class="p">();</span>
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Displays the current user's name and the message input field.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">InputView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">el</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#input&#39;</span><span class="p">),</span>
    
    <span class="nx">regex</span> <span class="o">:</span> <span class="sr">/@(\w+)/</span><span class="p">,</span>
    
    <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;click #send&quot;</span> <span class="o">:</span> <span class="s2">&quot;onSubmit&quot;</span><span class="p">,</span>
      <span class="s2">&quot;keypress #message&quot;</span> <span class="o">:</span> <span class="s2">&quot;keypress&quot;</span>
    <span class="p">},</span>
    
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;onSubmit&quot;</span><span class="p">,</span> <span class="s2">&quot;nameChanged&quot;</span><span class="p">,</span> <span class="s2">&quot;keypress&quot;</span><span class="p">);</span>
      <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change:name&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nameChanged</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">onSubmit</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#message&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Sanitize messages a bit before we send them to the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">executed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Do a regex check to see if it is a private message</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">executed</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nx">PrivateMessages</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="s2">&quot;from&quot;</span> <span class="o">:</span> <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;to&quot;</span> <span class="o">:</span> <span class="nx">executed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;message&quot;</span> <span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">executed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
          <span class="p">});</span>
        <span class="k">else</span>
          <span class="nx">Messages</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="s2">&quot;from&quot;</span> <span class="o">:</span> <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;message&quot;</span> <span class="o">:</span> <span class="nx">message</span>
          <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#message&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">nameChanged</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#name&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">));</span>
    <span class="p">},</span>
    
    <span class="nx">keypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Send message on ENTER</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onSubmit</span><span class="p">();</span>
    <span class="p">},</span>
    
    <span class="nx">fillAndFocus</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">){</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#message&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Represents a message entry</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">EntryView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">tagName</span> <span class="o">:</span> <span class="s2">&quot;li&quot;</span><span class="p">,</span>
    
    <span class="nx">template</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#entry-template&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>
    </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>If there's a change in our model, rerender it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">);</span>
    <span class="p">},</span>
    
    <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span> 
      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">content</span><span class="p">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>A private message</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">PrivateEntryView</span> <span class="o">=</span> <span class="nx">EntryView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">className</span> <span class="o">:</span> <span class="s2">&quot;private&quot;</span><span class="p">,</span>
    <span class="nx">template</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#private-entry-template&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">())</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The view for the chat messages</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">MessagesList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#messages&quot;</span><span class="p">),</span>
  
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;reseted&#39;</span><span class="p">,</span> <span class="s1">&#39;addRow&#39;</span><span class="p">,</span> <span class="s1">&#39;addPrivateRow&#39;</span><span class="p">);</span>
    
      <span class="nx">Messages</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">reseted</span><span class="p">);</span>
      <span class="nx">Messages</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addRow</span><span class="p">);</span>
      <span class="nx">PrivateMessages</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addPrivateRow</span><span class="p">);</span>
    <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Adds an entry row </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addRow</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comment</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EntryView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">comment</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">rendered</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">rendered</span><span class="p">);</span>
    <span class="p">},</span>
  
    <span class="nx">addPrivateRow</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">private_message</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PrivateEntryView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">private_message</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">rendered</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">rendered</span><span class="p">);</span>
    <span class="p">},</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Renders all comments into the table</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">reseted</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>reset the table</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">Messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>add each element</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Messages</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addRow</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  
  <span class="kd">var</span> <span class="nx">UserSession</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">UserListCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">db</span> <span class="o">:</span> <span class="p">{</span>
      <span class="nx">changes</span> <span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">url</span> <span class="o">:</span> <span class="s2">&quot;/user_list&quot;</span><span class="p">,</span>
    <span class="nx">model</span> <span class="o">:</span> <span class="nx">UserSession</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserListCollection</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">UserListEntry</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">tagName</span> <span class="o">:</span> <span class="s2">&quot;li&quot;</span><span class="p">,</span>
    <span class="nx">className</span> <span class="o">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
  
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;remove_me&#39;</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>When the session gets destroyed, the row will be destroyed too</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove_me</span><span class="p">)</span>
    <span class="p">},</span>
  
    <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Insert "@username" into the input field</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">Input</span><span class="p">.</span><span class="nx">fillAndFocus</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">;</span>
    <span class="p">},</span>
  
    <span class="nx">remove_me</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">});</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The list where all usernames are displayed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">UserListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">el</span> <span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#userlist&#39;</span><span class="p">),</span>
  
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;reseted&#39;</span><span class="p">,</span> <span class="s1">&#39;addRow&#39;</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The view listens to the realtime updates of the couchdb changes feed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">UserList</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addRow</span><span class="p">);</span>
      <span class="nx">UserList</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">reseted</span><span class="p">);</span>
    <span class="p">},</span>
  
    <span class="nx">addRow</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">new</span> <span class="nx">UserListEntry</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span><span class="nx">model</span><span class="p">}).</span><span class="nx">render</span><span class="p">());</span>
    <span class="p">},</span>
  
    <span class="nx">reseted</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">UserList</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addRow</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">UserList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserListCollection</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The App router initializes the app by calling <code>UserList.fetch()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">App</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">);</span>
      <span class="nx">UserList</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>The current session will be stored in here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">CurrentSession</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">Input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InputView</span><span class="p">();</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Booststrap app after delay to avoid continuous activity spinner </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Destroy the current session on unload</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">unload</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
        <span class="nx">async</span> <span class="o">:</span> <span class="kc">false</span>
      <span class="p">});</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">CurrentSession</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
        <span class="nx">CurrentSession</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">});</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Includes the couchlogin
check it out here: <a href="https://github.com/couchapp/couchdb-login-jquery">https://github.com/couchapp/couchdb-login-jquery</a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login&#39;</span><span class="p">).</span><span class="nx">couchLogin</span><span class="p">({</span>
      <span class="nx">loggedIn</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">){</span>
        <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
        <span class="nx">PrivateMessages</span><span class="p">.</span><span class="nx">listen_to_changes</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Only add a User if it's not already in the list</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">UserList</span><span class="p">.</span><span class="nx">detect</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">){</span><span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">);})){</span>
          <span class="nx">CurrentSession</span> <span class="o">=</span> <span class="nx">UserList</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span> <span class="o">:</span> <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;logged_in_at&quot;</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">loggedOut</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">PrivateMessages</span><span class="p">.</span><span class="nx">stop_changes</span><span class="p">();</span>
        <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">new</span> <span class="nx">UserModel</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">());</span>
        <span class="nx">CurrentUser</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change:name&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">CurrentSession</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
          <span class="nx">CurrentSession</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
    </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Bootstrapping</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">MessagesList</span><span class="p">();</span>
    <span class="k">new</span> <span class="nx">UserListView</span><span class="p">();</span>
    <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
    
  <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 